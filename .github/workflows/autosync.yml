name: autosync
on:
  push:
    paths:
      - '.github/workflows/autosync.yml'
      - '.github/packages.sh'
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *'

jobs:
  autosync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      - name: Resync Code
        run: |
          chmod +x .github/packages.sh
          ./.github/packages.sh

      - name: Push changes
        env:
          REPO_URL: https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git remote set-url origin "${REPO_URL}"
          
          # æ£€æµ‹å˜æ›´
          if git diff --quiet; then
            echo "æ— æ›´æ–°ï¼Œæ— éœ€æäº¤"
            exit 0
          fi

          # æ‹‰å–æœ€æ–°ä»£ç é¿å…å†²çª
          git pull origin main --rebase

          # ç”Ÿæˆéšæœº Emoji
          Emoji=(ğŸ‰ ğŸ¤ âœ¨ ğŸ ğŸˆ ğŸ„ ğŸ¨ ğŸ’‹ ğŸ“ ğŸ• ğŸ‰ ğŸ’ ğŸŒ´ ğŸš€ ğŸ›¸ ğŸ—½ â›… ğŸŒˆ ğŸ”¥ â›„ ğŸ¶ ğŸ… ğŸ¦„ ğŸ¤)
          RANDOM_EMOJI=${Emoji[$RANDOM % ${#Emoji[@]}]}

          # æäº¤å¹¶æ¨é€
          git add .
          git commit -m "${RANDOM_EMOJI} Sync $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin HEAD:main -f

      - name: Cleanup workflows
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 0
          keep_minimum_runs: 3
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
